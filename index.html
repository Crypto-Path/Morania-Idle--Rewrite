<!--
    TODO:
    - = done
    1.) - Finish implementing crafting menu tab
    2.) Make area switch look nice
    3.) Player stats
        A.) Monster Kills
        B.) - Strength / DMG
        C.) - Equipped weapon info
        D.) Fame (another progress bar?)
        E.) Rotating Player Sprite
            I.) Armor depending or currently equipped weapon
    4.) More audio for different things
        A.) Successful Crafting
        B.) Failed Crafting
        C.) -Equipping
        D.) - Unequipping
        E.) Failed Equipping
    5.) Area scenery for monster segment
    6.) Guild
        A.) Daily quest
        B.) A unique set of quests based on the day
        c.) Quest tiers
    7.) Draggable Menus
    8.) Panning and Zooming
        A.) Parallax
        B.) - Panning
        C.) - Zooming
    9.) More tooltips
        A.) Item Descriptions
    10.) Guide (tutorial)
    11.) UI Progression
    12.) Fix Inventory inconsistency (Item passover instead of lookup)
    13.) - Crafting table catagories
    14.) - Tooltip Issues
        A.) - Fix tooltip being in the wrong area
        B.) - Attribute info
        C.) - Follow cursor better
    15.) - Fix weird body offset
    16.) - Implement settings
-->




<!DOCTYPE html>
<html>
    <head>
        <title>
            Morania Idle: Rewrite
        </title>
        <link rel="stylesheet" type="text/css" href="styles.css">
        <link rel="stylesheet" type="text/css" href="styles/save.css">
        <link rel="stylesheet" type="text/css" href="styles/hitbox.css">
        <link rel="stylesheet" type="text/css" href="styles/inventory.css">
        <link rel="stylesheet" type="text/css" href="styles/craft.css">
        <link rel="stylesheet" type="text/css" href="styles/quests.css">
        <link rel="stylesheet" type="text/css" href="styles/bars.css">
        <link rel="stylesheet" type="text/css" href="styles/tooltip.css">
        <link rel="stylesheet" type="text/css" href="styles/lines.css">
        <link rel="stylesheet" type="text/css" href="styles/scrollBar.css">
    </head>
    <body>
        <script src="modules/functions.js"></script>
        <script src="modules/Item.js"></script>
        <script src="modules/DropChance.js"></script>
        <script src="modules/Monster.js"></script>
        <script src="modules/Area.js"></script>
        <script src="modules/Region.js"></script>
        <script src="modules/Quest.js"></script>
        <script src="modules/QuestLine.js"></script>
        <script src="modules/SaveAndLoad.js"></script>
        <script>
            const backgroundMusic = new Audio("Audio/Background.mp3");
            const attackAudio = new Audio("Audio/Attack.mp3");
            const deleteAudio = new Audio("Audio/Delete.wav");
            const dragAudio = new Audio("Audio/Drag.wav");
            const hoverAudio = new Audio("Audio/Hover.mp3");
            const releaseAudio = new Audio("Audio/Release.wav");
            const chinkAudio = new Audio("Audio/Chink.mp3");
            const equipAudio = new Audio("Audio/Equip.mp3");
            const tabAudio = new Audio("Audio/Tab.mp3");
            const packAudio = new Audio("Audio/Pack.mp3");

            function MasterVolume(vol) {
                backgroundMusic.volume = vol;
                attackAudio.volume = vol;
                deleteAudio.volume = vol;
                dragAudio.volume = vol;
                hoverAudio.volume = vol;
                releaseAudio.volume = vol;
                chinkAudio.volume = vol;
                equipAudio.volume = vol;
                tabAudio.volume = vol / 4;
            }

            MasterVolume(1)
        </script>
                    
        <div id="tooltip">
            <div class="diagonal-lines"></div>
            <p id="tooltipTitle">
            </p>
            <br>
            <br>
            <hr>
            <p id="tooltipDescription">
            </p>
        </div>
        <div id="save" class="container">
            <a>
                Load Save
            </a>
            <hr>
            <div class="hoverOutline card" onclick="{file.load(); document.getElementById('body').style.display = 'flex'; document.getElementById('save').style.display='none'}">
                <p id="saveDate"></p>
                <script>
                    const StartDate = new Date()
                    document.getElementById("saveDate").innerText = StartDate.toLocaleString();
                </script>
                <img id="saveCoverImage" src="Images/Monster_Slime_Small_Green.png" style="width: 100%;"/>
                <p id="saveStats">
                    Level: [1] 0/10 (0%) 
                </p>
            </div>
            <hr>
        </div>
        <div id="body" style="display: none;">
            <div>
                <div class="container">
                    <p>
                        Guild
                    </p>
                    <div id="QuestMenu">
                        <div class="itemsContainer">
                            <div id="questList" class="itemsList">
                                
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container Locked">
                    <p>
                        Shop
                    </p>
                    <div class="itemsContainer" style="background-color: rgb(150, 150, 150);">
                        <div class="itemsList">
                            <p>
                                Coming Soon
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <div class="container">
                    <p>
                        Inventory
                    </p>
                    <div id="Inventory" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="0" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="1" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="2" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="3" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="4" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="5" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="6" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="7" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="8" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="9" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="10" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="11" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="12" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="13" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="14" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="15" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="16" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="17" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="18" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="19" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="20" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="21" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="22" draggable="false" class="slotIMG" src="" /></div></div>
                        <div class="item" draggable="true" ondragstart="drag(event)"><div><img id="23" draggable="false" class="slotIMG" src="" /></div></div>
                    </div>
                </div>
                <div class="container">
                    <p>
                        Crafting Menu
                    </p>
                    <div id="CraftingMenu">
                        <div id="CraftingMenuItemsContainer">
                            <p id="Catagory">
                                <button onclick="{game.previousCategory(); PlayAudio(tabAudio)}"><</button>
                                <a id="CategoryText">
                                    All
                                </a>   
                                <button onclick="{game.nextCategory(); PlayAudio(tabAudio)}">></button>
                            </p>
                            <div class="CraftingList">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
        
                // Get all elements with the class "item"
                const slots = document.getElementsByClassName('item');
                let deslot = null;
        
                // Attach the event listener to each element
                for (let i = 0; i < slots.length; i++) {
                    slots[i].addEventListener('mousedown', () => {
                        tooltip.style.display = 'none';
                        deslot = slots[i].children[0].children[0].id;
                        if (event.button === 0) {
                            PlayAudio(hoverAudio)
                        }
                        if (event.button === 2) {
                            event.preventDefault();
                            PlayAudio(deleteAudio)
                            game.inventory.removeItem(game.inventory.inventory[deslot][0].name);
                            setToolTipText()
                        }
                    });
                }

                document.addEventListener("DOMContentLoaded", function() {
                    const dropzone = document.getElementById("dropzone");
                
                    // Prevent default behavior for drag events
                    dropzone.addEventListener("dragenter", function(event) {
                        event.preventDefault();
                    });
                
                    dropzone.addEventListener("dragover", function(event) {
                        event.preventDefault();
                    });
                
                    // Handle drop event
                    dropzone.addEventListener("drop", function(event) {
                        console.log("Equiping Item: " + game.inventory.inventory[deslot][0].name)
                        game.equipItem(game.inventory.inventory[deslot][0].name)
                        event.preventDefault();
                    });
                });
            </script>
            
            <script src="modules/toolTips.js"></script>
            <script src="modules/Inventory.js"></script>

            <div>
                <div class="container">
                    <div id="MonsterContainer">
                        <p id="MonsterName">
                            Small Green Slime
                        </p>
                        <div id="hitBox">
                            <img id="hitBoxImage">
                        </div>
                        <div id="MonsterHealthBar" class="bar background barFlex">
                            <div id="InnerHealthBarContainer" class="bar">
                                <div id="MonsterHealthBarInner" class="bar">
                                </div>
                                <div id="SecondMonsterHealthBarInner" class="bar">
                                </div>
                            </div>
                            <p id="HealthBarInnerText">
                                10 / 10
                            </p>
                        </div>
                    </div>
                </div>
                <div class="container">
                    <div class="barFlex">
                        <button onclick="{game.previousArea(); RenderHPBar(monsterNameText, healthBarInner, secondHealthBarInner, healthBarText); PlayAudio(tabAudio)}"><</button>
                        <p id="AreaName">
                            Green Plains
                        </p>
                        <button onclick="{game.nextArea(); RenderHPBar(monsterNameText, healthBarInner, secondHealthBarInner, healthBarText); PlayAudio(tabAudio)}">></button>
                    </div>
                </div>
            </div>
            


            <div>
                <div class="container">
                    <p>
                        Player Stats
                    </p>
                    <p id="PlayerStatsText" class="stats">
                    </p>
                    <span>
                        <div id="dropzone" onclick="{game.unequipItem()}" class="item"><div><img id="EquippedSlot" draggable="false" src="Images/Slot_Equipment_Sword.png" /></div></div>
                    </span>
                    <br>
                    <div id="XPBarBackground" class="bar background barFlex">
                        <div id="XPBar" class="bar">
                            <div id="XPBar" class="bar">
                                <div class="diagonal-bars"></div>
                            </div>
                        </div>
                        <p id="XPProgress">
                            [1] 0 / 10 (0%)
                        </p>
                    </div>
                    <br>
                </div>
                <div class="container">
                    <p>
                        Settings
                    </p>
                    <label for="masterVolume">Master Volume</label><br>
                    <input id="masterVolume" type="range" min="0" max="100" value="100" onchange="{document.getElementById('masterVolumePercent').innerText = this.value + '%'; MasterVolume(this.value / 100);}"><p id="masterVolumePercent">100%</p>
                    <input onchange="{autoAttack = this.checked;}" type="checkbox">
                    <a>Idle Mode</a>
                    <hr>
                    <button onclick="{file.save(); file.loaded = true}">Save</button><br>
                    <button class="redText" onclick="{localStorage['file'] = undefined; file.loaded = false; alert('(Auto save disable, save to re-enable)\n If you accidentally pressed this, don\'t worry, just save after this message and it\'ll be like nothing happened :)')}">Delete Save</button>
                </div>
            </div>
        </div>
        
        <script>
            let scale = 1;
            window.addEventListener('wheel', function(event) {
                if (isChildOfContainerElement(event.target)) {
                    return;
                }

                if (event.deltaY < 0) {
                    scale += 0.01; 
                } else if (event.deltaY > 0) {
                    scale -= 0.01;
                }
                
                if (scale > 2)
                    scale = 2;

                if (scale < 0.5)
                    scale = 0.5;

                document.getElementById('body').style.transform = `scale(${scale})`;
              });

              function isChildOfContainerElement(element) {
                if (!element) {
                    return false;
                }
            
                let parent = element;
            
                while (parent) {
                    if (parent.classList.contains('container')) {
                        return true; // Found an ancestor with overflow
                    }
                    parent = parent.parentElement;
                }
            
                return false; // No ancestor with overflow found
            }
        </script>

        <script src="Game.js"></script>
        <script>
            let game = null
            let file = null;

            let hitBox = document.getElementById("hitBox");
            let hitBoxImage = document.getElementById("hitBoxImage");
            let monsterNameText = document.getElementById("MonsterName");
            let healthBarText = document.getElementById("HealthBarInnerText");
            let healthBarInner = document.getElementById("MonsterHealthBarInner");
            let secondHealthBarInner = document.getElementById("SecondMonsterHealthBarInner");

            let areaName = document.getElementById("AreaName");

            let autoAttack = false;

            document.addEventListener("DOMContentLoaded", function() {
                game = new Game();
                game.inventory = new Inventory(document.querySelectorAll('.slotIMG'));
                game.updateStats();
                file = new SaveAndLoad(game, StartDate);
                //game.inventory.addItem(game.Items["Slime-Green"], 10000)
                // game.inventory.addItem(game.Items["Slime-Yellow"], 10)

                hitBox.addEventListener("click", ()=> {
                    if (!autoAttack) {
                        hit(game);
                    }
                })
            });

            autoAttackLoop = setInterval(() => {
                if (autoAttack) {
                    hit(game, false);
                }
            }, 1000)

            function hit(game, input = true) {
                if (input) {
                    hitHitBox();
                    PlayAudio(attackAudio, 220);
                }
                RenderHPBar(monsterNameText, healthBarInner, secondHealthBarInner, healthBarText);
                game.attackMonster()
            }

            function RenderHPBar (nText, hBar, hBar2, hBarText) {
                hBar.style.width = 190 * game.currentMonster.hp / game.currentMonster.maxHp + "px";
                hBar2.style.width = 190 * game.currentMonster.hp / game.currentMonster.maxHp + "px";
                hBarText.innerText = `${Math.ceil(game.currentMonster.hp)} / ${game.currentMonster.maxHp}`;
                nText.innerText = game.currentMonster.name;

                if (game.currentMonster.hp <= 0) {
                    hBar.style.width = 190 * game.currentMonster.hp / game.currentMonster.maxHp + "px";
                    hBar2.style.width = 190 * game.currentMonster.hp / game.currentMonster.maxHp + "px";
                    hBarText.innerText = `${Math.ceil(game.currentMonster.hp)} / ${game.currentMonster.maxHp}`;
                    nText.innerText = game.currentMonster.name;
                }
            }

            function hitHitBox() {
                var hitBox = document.getElementById("hitBoxImage");
                
                var randomAngle = Math.floor(Math.random() * 181) - 90;
                var randomDirection = Math.random() < 0.5 ? -1 : 1;
                hitBox.style.transform = "rotate(" + randomDirection * randomAngle + "deg)";
                
                setTimeout(() => {
                    hitBox.style.transition = "transform 1s";
                    hitBox.style.transform = "rotate(0deg)";
                }, 60)

                setTimeout(() => {
                    hitBox.style.transition = "";
                    hitBox.style.transform = "";
                }, 1200);
            }
        </script>

        <script>
            document.addEventListener("click", function() {
            
                function loopBackgroundMusic() {
                    this.currentTime = 0;
                    this.play();
                }
            
                backgroundMusic.addEventListener("ended", loopBackgroundMusic);
            
                backgroundMusic.play();
                
                // Remove the click event listener after it's been triggered once
                document.removeEventListener("click", arguments.callee);
            });
        </script>
        
        <script>
            const bodyElement = document.getElementById('body');

            let keysDown = {
                "ArrowUp" : false,
                "ArrowDown" : false,
                "ArrowLeft" : false,
                "ArrowRight" : false
            }

            let moveInterval = null;
            const body = document.getElementById("body");
            body.style.top = `0px`;
            body.style.left = `0px`;

            const moveSpeed = 5;

            setInterval(() => {
                if(keysDown["ArrowUp"])
                    body.style.top = `${parseInt(body.style.top) + moveSpeed}px`;
                if(keysDown["ArrowDown"])
                    body.style.top = `${parseInt(body.style.top) - moveSpeed}px`;
                if(keysDown["ArrowLeft"])
                    body.style.left = `${parseInt(body.style.left) + moveSpeed}px`;
                if(keysDown["ArrowRight"])
                    body.style.left = `${parseInt(body.style.left) - moveSpeed}px`;
            }, 15);

            document.addEventListener('keydown', (event) => {
                keysDown[event.key] = true;
            });

            document.addEventListener('keyup', (event) => {
                keysDown[event.key] = false;
            });
        </script>
        <div class="diagonal-lines"></div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                document.getElementById("saveDate").innerText = file.getSaveCoverData()[0].toLocaleString();
                document.getElementById("saveStats").innerText = `[${file.getSaveCoverData()[2]}] ${file.getSaveCoverData()[1]} / ${game.getXpReq(file.getSaveCoverData()[2])} (${Math.round(100 * file.getSaveCoverData()[1] / game.getXpReq(file.getSaveCoverData()[2]))}%)`;
                document.getElementById("saveCoverImage").src = (file.getSaveCoverData()[3] != undefined) ? getImageURL(file.getSaveCoverData()[3].sprite) : getImageURL("Monster_Slime_Small_Green");
            })

            setInterval(() => {
                if(file.loaded)
                    file.save();

                console.log("Auto Save!")
            }, 1000 * 60 * 5)

            window.addEventListener('beforeunload', function (e) {
                if(file.loaded) {
                    e.preventDefault();
                    file.save();
                }
            });
        </script>
        <a class="bottom-right">
            MI: v1.0.1a
        </a>
    </body>
</html>